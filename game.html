<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phaser 4 Scene Game</title>
    <!-- Include Phaser framework -->
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.js"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #3f3851;
        }

        canvas {
            display: block;
            background-color: #3f3851;
        }
    </style>
</head>

<body>

    <script>
        // Classe per gestire il gatto
        class Cat {
    constructor(scene) {
        this.scene = scene;
        this.gatto = null;
        this.lives = 3;
        this.coins = 0;
        this.livesText = null;
        this.coinsText = null;
        this.isAttacking = false;
        this.attackTimer = 0;

        // Define hitbox sizes
        this.defaultHitbox = { width: 570, height: 480, offsetX: 240, offsetY: 720 };
        this.attackHitbox = { width: 800, height: 600, offsetX: 260, offsetY: 600 };
    }

    preload() {
        this.scene.load.spritesheet('gatto_idle', 'assets/gatto_fermo.png', { frameWidth: 1200, frameHeight: 1200 });
        this.scene.load.spritesheet('gatto_walk', 'assets/gatto_camminata.png', { frameWidth: 1200, frameHeight: 1200 });
        this.scene.load.spritesheet('gatto_run', 'assets/gatto_corsa.png', { frameWidth: 1200, frameHeight: 1200 });
        this.scene.load.spritesheet('gatto_attacco', 'assets/gatto_attacco.png', { frameWidth: 1200, frameHeight: 1200 });
        this.scene.load.spritesheet('coin', 'assets/coin.png', { frameWidth: 64, frameHeight: 64 });
    }

    create(x, y) {
        this.gatto = this.scene.physics.add.sprite(x, y, 'gatto_idle');
        this.gatto.setScale(0.13);
        this.setDefaultHitbox();
        this.gatto.body.setGravityY(300);
        this.gatto.setBounce(0.01);
        this.gatto.setCollideWorldBounds(true);

        // Define animations
        this.scene.anims.create({ key: 'idle', frames: this.scene.anims.generateFrameNumbers('gatto_idle', { start: 0, end: 7 }), frameRate: 10, repeat: -1 });
        this.scene.anims.create({ key: 'walk', frames: this.scene.anims.generateFrameNumbers('gatto_walk', { start: 0, end: 7 }), frameRate: 10, repeat: -1 });
        this.scene.anims.create({ key: 'run', frames: this.scene.anims.generateFrameNumbers('gatto_run', { start: 0, end: 3 }), frameRate: 12, repeat: -1 });
        this.scene.anims.create({ key: 'attack', frames: this.scene.anims.generateFrameNumbers('gatto_attacco', { start: 0, end: 4 }), frameRate: 12, repeat: 0 });

        this.gatto.anims.play('idle');
        this.livesText = this.scene.add.text(16, 16, 'Vite: 3', { fontSize: '32px', fill: '#fff' });
        this.coinsText = this.scene.add.text(16, 56, 'Monete: 0', { fontSize: '32px', fill: '#fff' });
    }

    setDefaultHitbox() {
        this.gatto.body.setSize(this.defaultHitbox.width, this.defaultHitbox.height);
        this.gatto.body.setOffset(this.gatto.flipX ? this.defaultHitbox.offsetX + 150 : this.defaultHitbox.offsetX, this.defaultHitbox.offsetY);
    }

    setAttackHitbox() {
        this.gatto.body.setSize(this.attackHitbox.width, this.attackHitbox.height);
        this.gatto.body.setOffset(this.gatto.flipX ? this.attackHitbox.offsetX - 150 : this.attackHitbox.offsetX, this.attackHitbox.offsetY);
    }

    update(cursors, keys) {
        const speed = 300;
        const runSpeed = 600;
        const attackCooldown = 500; // Millisecondi di cooldown tra gli attacchi

        if (this.isAttacking) {
            this.setAttackHitbox();
            this.gatto.anims.play('attack', true);
            this.gatto.body.setAllowGravity(false);
            if (this.scene.time.now > this.attackTimer) {
                this.isAttacking = false;
                this.setDefaultHitbox();
                this.gatto.body.setAllowGravity(true);
            }
        } else {
            this.setDefaultHitbox();

            if (cursors.left.isDown || keys.left.isDown) {
                this.gatto.setVelocityX(keys.shift.isDown ? -runSpeed : -speed);
                this.gatto.flipX = true;
                this.gatto.anims.play(keys.shift.isDown ? 'run' : 'walk', true);
            } else if (cursors.right.isDown || keys.right.isDown) {
                this.gatto.setVelocityX(keys.shift.isDown ? runSpeed : speed);
                this.gatto.flipX = false;
                this.gatto.anims.play(keys.shift.isDown ? 'run' : 'walk', true);
            } else {
                this.gatto.setVelocityX(0);
                this.gatto.anims.play('idle', true);
            }

            if (keys.jump.isDown && this.gatto.body.touching.down) {
                this.gatto.setVelocityY(-500);
            }
        }

        if (keys.attack.isDown) {
            if (!this.isAttacking && this.scene.time.now > this.attackTimer) {
                this.isAttacking = true;
                this.gatto.anims.play('attack');
                this.attackTimer = this.scene.time.now + attackCooldown;
                this.gatto.body.setAllowGravity(false);
            }
        }

        if (this.livesText) {
            this.livesText.setText('Vite: ' + this.lives);
        }

        if (this.coinsText) {
            this.coinsText.setText('Monete: ' + this.coins + '/25');
        }
    }

    loseLife() {
        this.lives--;
        if (this.lives <= 0) {
            console.log('Game Over');
            this.scene.scene.restart();
        }
    }

    increaseLife() {
        this.lives++;
        if (this.livesText) {
            this.livesText.setText('Vite: ' + this.lives);
        }
    }

    collectCoin() {
        this.coins++;
    }
}


// Funzione per creare piattaforme rettangolari
function createRectangularPlatforms(scene, platformsData) {
    const platforms = scene.add.group();
    platformsData.forEach(data => {
        const platform = scene.add.rectangle(data.x, data.y, data.width, data.height, data.color).setOrigin(0.5, 0.5);
        scene.physics.add.existing(platform, true);
        platforms.add(platform);
    });
    return platforms;
}


        // Funzione per creare monete
        function createCoins(scene, coinsData) {
            const coins = scene.physics.add.group({
                key: 'coin',
                frameQuantity: coinsData.length,
                collideWorldBounds: true,
                immovable: false // Le monete devono essere in movimento
            });

            coins.children.iterate((coin, index) => {
                const data = coinsData[index];
                coin.setPosition(data.x, data.y);
                coin.setScale(0.7);
                coin.setOrigin(0.5, 0.5);
                coin.setSize(64, 64);
                coin.setOffset(0, 0);

                scene.anims.create({
                    key: 'spin',
                    frames: scene.anims.generateFrameNumbers('coin', { start: 0, end: 13 }),
                    frameRate: 24,
                    repeat: -1
                });
                coin.anims.play('spin');
            });

            return coins;
        }
        class Scene1 extends Phaser.Scene {
    constructor() {
        super({ key: 'Scene1' });
        this.cat = new Cat(this);
        this.coinPositions = [
            { x: 800, y: 300 },
            { x: 1100, y: 300 },
            { x: 1300, y: 700 },
            { x: 900, y: 160 },
            { x: 1370, y: 200 },
            { x: 1000, y: 600 },
            { x: 1190, y: 500 },
            { x: 550, y: 300 },
            { x: 700, y: 800 },
            { x: 1450, y: 700 }
        ];
        this.startingPosition = { x: 932, y: 600 }; // Punto di partenza del gatto
        this.currentCoins = 0; // Numero di monete raccolte
        this.bonusSpawnInterval = Phaser.Math.Between(7, 20); // Numero di monete raccolte prima di far comparire un bonus
        this.usedCoinPositions = []; // Per tenere traccia delle posizioni delle monete già usate
    }

    preload() {
        this.cat.preload();
        this.load.image('mappa_1', 'assets/mappa_1.png');
        this.load.image('bonus', 'assets/Healthpotion.png');
        this.load.image('coin', 'assets/coin.png'); // Assicurati di avere una chiave per l'immagine delle monete

        this.load.audio('coin_sound', 'assets/suono_raccolta_moneta_2.mp3');
        this.load.audio('25coin_sound', 'assets/suono_raccolta_moneta_1.mp3');
        this.load.audio('damage_sound', 'assets/suono_acqua.mp3');
        this.load.audio('bonus_sound', 'assets/potion_sound.mp3'); 
        this.load.audio('background_music', 'assets/backround_music.mp3');
    }

    create() {
        this.add.image(this.scale.width / 2, this.scale.height / 2, 'mappa_1');
        this.cat.create(this.startingPosition.x, this.startingPosition.y);

        this.backgroundMusic = this.sound.add('background_music');
        this.backgroundMusic.setVolume(0.05);
        this.backgroundMusic.play({ loop: true });

        // Crea le piattaforme
        this.platforms = createRectangularPlatforms(this, [
            { x: 992, y: 32, width: 960, height: 64 },
            { x: 1440, y: 320, width: 64, height: 512 },
            { x: 544, y: 160, width: 64, height: 192 },
            { x: 480, y: 288, width: 64, height: 192 },
            { x: 544, y: 448, width: 64, height: 256 },
            { x: 480, y: 672, width: 64, height: 320 },
            { x: 1504, y: 672, width: 64, height: 320 },
            { x: 544, y: 832, width: 64, height: 128 },
            { x: 1440, y: 832, width: 64, height: 128 },
            { x: 704, y: 960, width: 384, height: 128 },
            { x: 1280, y: 960, width: 384, height: 128 },
            { x: 960, y: 224, width: 512, height: 64 },
            { x: 1376, y: 288, width: 64, height: 64 },
            { x: 1088, y: 416, width: 256, height: 64 },
            { x: 704, y: 480, width: 256, height: 64 },
            { x: 1344, y: 608, width: 256, height: 64 },
            { x: 928, y: 736, width: 448, height: 64 }
        ]);

        // Crea le piattaforme pericolose
        this.dangerousPlatforms = createRectangularPlatforms(this, [
            { x: 992, y: 994, width: 192, height: 60 }
        ]);

        // Crea le monete
        this.coins = this.physics.add.group({
            key: 'coin',
            frameQuantity: 0, // Nessuna moneta inizialmente
            collideWorldBounds: true,
            immovable: false
        });

        // Mostra la prima moneta
        this.showNextCoin();

        // Gestisci le collisioni
        this.physics.add.collider(this.cat.gatto, this.platforms);
        this.physics.add.collider(this.coins, this.platforms);
        this.physics.add.collider(this.cat.gatto, this.dangerousPlatforms, this.handleDangerousPlatformCollision, null, this);
        this.physics.add.overlap(this.cat.gatto, this.coins, (cat, coin) => {
            coin.setAlpha(0); // Nascondi la moneta
            this.coins.remove(coin); // Rimuovi la moneta dal gruppo
            this.cat.collectCoin(); // Incrementa il numero delle monete
            this.currentCoins++;
            if (this.currentCoins % this.bonusSpawnInterval === 0) {
                this.showBonus(); // Mostra la pozione bonus
            }
            if (this.currentCoins < 25) {
                this.showNextCoin(); // Mostra la prossima moneta
            } else {
                this.sound.play('25coin_sound');
                // Passa alla scena successiva se sono state raccolte 25 monete
                this.scene.start('Scene2');
            }
            this.sound.play('coin_sound');
        });

        // Configura i tasti di input
        this.cursors = this.input.keyboard.createCursorKeys();
        this.keys = {
            left: this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.A),
            right: this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.D),
            shift: this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.SHIFT),
            jump: this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.SPACE),
            attack: this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.E)
        };
    }

    update() {
        this.cat.update(this.cursors, this.keys);
    }

    showNextCoin() {
        if (this.currentCoins >= 25) return; // Non mostrare più monete se ne sono state raccolte 25

        // Seleziona una posizione casuale dalle posizioni disponibili
        let availablePositions = this.coinPositions.filter(pos => !this.usedCoinPositions.includes(pos));
        if (availablePositions.length === 0) return; // Nessuna posizione disponibile

        const randomIndex = Phaser.Math.Between(0, availablePositions.length - 1);
        const { x, y } = availablePositions[randomIndex];

        // Crea una nuova moneta nella posizione specificata
        const coin = this.coins.create(x, y, 'coin');
        coin.setScale(0.7);
        coin.setOrigin(0.5, 0.5);
        coin.setSize(64, 64);
        coin.setOffset(0, 0);

        // Aggiungi la posizione della moneta all'elenco delle posizioni usate
        this.usedCoinPositions.push({ x, y });

        // Crea l'animazione di rotazione per la moneta
        this.anims.create({
            key: 'spin',
            frames: this.anims.generateFrameNumbers('coin', { start: 0, end: 13 }),
            frameRate: 24,
            repeat: -1
        });
        coin.anims.play('spin');
    }

    showBonus() {
        if (this.bonus) {
            this.bonus.destroy(); // Distruggi la pozione esistente se presente
        }

        // Seleziona una posizione casuale dalle posizioni delle monete usate
        if (this.usedCoinPositions.length === 0) return; // Nessuna posizione disponibile

        const randomIndex = Phaser.Math.Between(0, this.usedCoinPositions.length - 1);
        const { x, y } = this.usedCoinPositions[randomIndex];

        // Crea la pozione bonus nella posizione selezionata
        this.bonus = this.physics.add.sprite(x, y, 'bonus');
        this.bonus.setScale(1.4); // Aumenta la dimensione della pozione
        this.bonus.setSize(20, 25); // Imposta la dimensione fisica della pozione
        this.bonus.setOffset(0, 0); // Offset per centrare la dimensione fisica
        this.physics.add.collider(this.bonus, this.platforms); // Abilita la collisione tra bonus e piattaforme
        this.physics.add.overlap(this.cat.gatto, this.bonus, this.collectBonus, null, this); // Gestisci la collisione con il bonus
    }

    handleDangerousPlatformCollision(cat, platform) {
        this.sound.play('damage_sound');
        this.cat.loseLife(); // Riduci la vita del gatto
        this.cat.gatto.setPosition(this.startingPosition.x, this.startingPosition.y); // Riporta il gatto al punto di partenza
    }

    collectBonus(cat, bonus) {
        this.sound.play('bonus_sound'); // Riproduci il suono del bonus
        this.cat.increaseLife(); // Aumenta la vita del gatto
        bonus.disableBody(true, true); // Nascondi e disabilita il bonus dopo che è stato raccolto
    }
}

// Scene 2
class Scene2 extends Phaser.Scene {
    constructor() {
        super({ key: 'Scene2' });
        this.cat = new Cat(this);
        this.coinPositions = [ // Posizioni delle monete in Scene2
            { x: 800, y: 800 },
            { x: 600, y: 280 },
            { x: 1500, y: 480 },
            { x: 700, y: 150 },
            { x: 400, y: 800 },
            { x: 1200, y: 780 },
            { x: 800, y: 680 },
            { x: 1100, y: 280 },
            { x: 1750, y: 480 },
            { x: 1550, y: 680 }
        ];
        this.startingPosition = { x: 620, y: 300 }; // Punto di partenza del gatto
        this.currentCoins = 0; // Numero di monete raccolte
        this.bonusSpawnInterval = Phaser.Math.Between(7, 20); // Numero di monete raccolte prima di far comparire un bonus
    }

    preload() {
        this.cat.preload();
        this.load.image('mappa_2', 'assets/mappa_2.png');
        this.load.spritesheet('coin', 'assets/coin_spritesheet.png', { frameWidth: 32, frameHeight: 32 });
        this.load.image('bonus', 'assets/Healthpotion.png'); // Carica l'immagine del bonus
        this.load.audio('coin_sound', 'assets/suono_raccolta_moneta_2.mp3');
        this.load.audio('25coin_sound', 'assets/suono_raccolta_moneta_1.mp3');
        this.load.audio('damage_sound', 'assets/suono_acqua.mp3');
        this.load.audio('bonus_sound', 'assets/potion_sound.mp3');
        this.load.audio('background_music', 'assets/backround_music.mp3');
    }

    create() {
        this.add.image(this.scale.width / 2, this.scale.height / 2, 'mappa_2');
        this.cat.create(this.startingPosition.x, this.startingPosition.y);

        this.backgroundMusic = this.sound.add('background_music');
        this.backgroundMusic.setVolume(0.05);
        this.backgroundMusic.play({ loop: true });

        // Crea le piattaforme
        this.platforms = createRectangularPlatforms(this, [
            { x: 1088, y: 32, width: 1280, height: 64 },
            { x: 480, y: 96, width: 64, height: 64 },
            { x: 1600, y: 96, width: 128, height: 64 },
            { x: 1632, y: 160, width: 64, height: 64 },
            { x: 1696, y: 256, width: 64, height: 384 },
            { x: 1760, y: 416, width: 64, height: 64 },
            { x: 1824, y: 544, width: 64, height: 320 },
            { x: 1760, y: 672, width: 64, height: 64 },
            { x: 1696, y: 736, width: 64, height: 192 },
            { x: 1760, y: 896, width: 64, height: 256 },
            { x: 416, y: 160, width: 64, height: 320 },
            { x: 352, y: 352, width: 64, height: 192 },
            { x: 416, y: 576, width: 64, height: 384 },
            { x: 352, y: 736, width: 64, height: 64 },
            { x: 288, y: 832, width: 64, height: 256 },
            { x: 416, y: 928, width: 192, height: 64 },
            { x: 480, y: 992, width: 64, height: 64 },
            { x: 800, y: 224, width: 448, height: 64 },
            { x: 608, y: 416, width: 64, height: 64 },
            { x: 1472, y: 288, width: 256, height: 64 },
            { x: 1056, y: 416, width: 320, height: 64 },
            { x: 640, y: 672, width: 256, height: 64 },
            { x: 992, y: 736, width: 192, height: 64 },
            { x: 1440, y: 608, width: 320, height: 64 },
            { x: 1504, y: 800, width: 192, height: 64 },
            { x: 736, y: 864, width: 192, height: 64 },
            { x: 1184, y: 864, width: 320, height: 64 }
        ]);

        // Crea la piattaforma pericolosa
        this.dangerousPlatforms = createRectangularPlatforms(this, [
            { x: 1120, y: 994, width: 1216, height: 60 }
        ]);

        // Crea le monete
        this.coins = this.physics.add.group({
            key: 'coin',
            frameQuantity: 0, // Nessuna moneta inizialmente
            collideWorldBounds: true,
            immovable: false
        });

        // Crea il bonus
        this.bonus = null; // Variabile per il bonus

        // Mostra la prima moneta
        this.showNextCoin();

        // Gestisci le collisioni
        this.physics.add.collider(this.cat.gatto, this.platforms);
        this.physics.add.collider(this.coins, this.platforms);
        this.physics.add.collider(this.cat.gatto, this.dangerousPlatforms, this.handleDangerousPlatformCollision, null, this);
        this.physics.add.overlap(this.cat.gatto, this.coins, (cat, coin) => {
            coin.setAlpha(0); // Nascondi la moneta
            this.coins.remove(coin); // Rimuovi la moneta dal gruppo
            this.cat.collectCoin(); // Incrementa il numero delle monete
            this.currentCoins++;
            if (this.currentCoins % this.bonusSpawnInterval === 0) {
                this.showBonus(); // Mostra la pozione bonus
            }
            if (this.currentCoins < 25) {
                this.showNextCoin(); // Mostra la prossima moneta
            } else {
                this.sound.play('25coin_sound');
                // Passa alla scena successiva se sono state raccolte 25 monete
                this.scene.start('Scene3');
            }
            this.sound.play('coin_sound');
        });

        // Configura i tasti di input
        this.cursors = this.input.keyboard.createCursorKeys();
        this.keys = {
            left: this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.A),
            right: this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.D),
            shift: this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.SHIFT),
            jump: this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.SPACE),
            attack: this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.E)
        };
    }

    update() {
        this.cat.update(this.cursors, this.keys);
    }

    showNextCoin() {
        if (this.currentCoins >= 25) return; // Non mostrare più monete se ne sono state raccolte 25

        // Seleziona una posizione casuale dalle posizioni disponibili
        const randomIndex = Phaser.Math.Between(0, this.coinPositions.length - 1);
        const { x, y } = this.coinPositions[randomIndex];

        // Crea una nuova moneta nella posizione specificata
        const coin = this.coins.create(x, y, 'coin');
        coin.setScale(0.7);
        coin.setOrigin(0.5, 0.5);
        coin.setSize(64, 64);
        coin.setOffset(0, 0);

        // Crea l'animazione di rotazione per la moneta
        this.anims.create({
            key: 'spin',
            frames: this.anims.generateFrameNumbers('coin', { start: 0, end: 13 }),
            frameRate: 24,
            repeat: -1
        });
        coin.anims.play('spin');
    }

    showBonus() {
        if (this.bonus) {
            this.bonus.destroy(); // Distruggi la pozione esistente se presente
        }

        // Seleziona una posizione casuale dalle posizioni delle monete già usate
        if (this.coins.getLength() === 0) return; // Nessuna moneta disponibile per determinare la posizione del bonus

        // Seleziona una posizione casuale tra le posizioni delle monete
        const randomIndex = Phaser.Math.Between(0, this.coinPositions.length - 1);
        const { x, y } = this.coinPositions[randomIndex];

        // Crea la pozione bonus nella posizione selezionata
        this.bonus = this.physics.add.sprite(x, y, 'bonus');
        this.bonus.setScale(1.4); // Aumenta la dimensione della pozione
        this.bonus.setSize(20, 25); // Imposta la dimensione fisica della pozione
        this.bonus.setOffset(0, 0); // Offset per centrare la dimensione fisica
        this.physics.add.collider(this.bonus, this.platforms); // Abilita la collisione tra bonus e piattaforme
        this.physics.add.overlap(this.cat.gatto, this.bonus, this.collectBonus, null, this); // Gestisci la collisione con il bonus
    }

    handleDangerousPlatformCollision(cat, platform) {
        this.sound.play('damage_sound');
        this.cat.loseLife(); // Riduci la vita del gatto
        this.cat.gatto.setPosition(this.startingPosition.x, this.startingPosition.y); // Riporta il gatto al punto di partenza
    }

    collectBonus(cat, bonus) {
        this.sound.play('bonus_sound'); // Riproduci il suono del bonus
        this.cat.increaseLife(); // Aumenta la vita del gatto
        bonus.disableBody(true, true); // Nascondi e disabilita il bonus dopo che è stato raccolto
    }
}



        // Scene 3
class Scene3 extends Phaser.Scene {
    constructor() {
        super({ key: 'Scene3' });
        this.cat = new Cat(this);
        this.coinPositions = [ // Posizioni delle monete in Scene3
            { x: 600, y: 600 },
            { x: 800, y: 400 },
            { x: 1200, y: 300 },
            { x: 1400, y: 500 },
            { x: 880, y: 700 },
            { x: 950, y: 200 },
            { x: 500, y: 300 },
            { x: 500, y: 700 }
        ];
        this.startingPosition = { x: 500, y: 700 }; // Punto di partenza del gatto
        this.currentCoins = 0; // Numero di monete raccolte
        this.bonusSpawnInterval = Phaser.Math.Between(7, 20); // Numero di monete raccolte prima di far comparire un bonus
    }

    preload() {
        this.cat.preload();
        this.load.image('mappa_3', 'assets/mappa_3.png');
        this.load.spritesheet('coin', 'assets/coin_spritesheet.png', { frameWidth: 32, frameHeight: 32 });
        this.load.image('bonus', 'assets/Healthpotion.png'); // Carica l'immagine del bonus
        this.load.audio('coin_sound', 'assets/suono_raccolta_moneta_2.mp3');
        this.load.audio('25coin_sound', 'assets/suono_raccolta_moneta_1.mp3');
        this.load.audio('damage_sound', 'assets/suono_acqua.mp3');
        this.load.audio('bonus_sound', 'assets/potion_sound.mp3');
        this.load.audio('background_music', 'assets/backround_music.mp3');
    }

    create() {
        this.add.image(this.scale.width / 2, this.scale.height / 2, 'mappa_3');
        this.cat.create(this.startingPosition.x, this.startingPosition.y);

        this.backgroundMusic = this.sound.add('background_music');
        this.backgroundMusic.setVolume(0.05);
        this.backgroundMusic.play({ loop: true });

        // Crea le piattaforme
        this.platforms = createRectangularPlatforms(this, [
            { x: 928, y: 32, width: 704, height: 64 },
            { x: 608, y: 96, width: 64, height: 64 },
            { x: 1248, y: 96, width: 64, height: 64 },
            { x: 512, y: 160, width: 256, height: 64 },
            { x: 1344, y: 160, width: 256, height: 64 },
            { x: 416, y: 352, width: 64, height: 320 },
            { x: 1440, y: 320, width: 64, height: 256 },
            { x: 1504, y: 416, width: 64, height: 64 },
            { x: 1568, y: 576, width: 64, height: 384 },
            { x: 1376, y: 738, width: 320, height: 64 },
            { x: 1184, y: 800, width: 64, height: 64 },
            { x: 1120, y: 896, width: 64, height: 256 },
            { x: 864, y: 896, width: 64, height: 256 },
            { x: 800, y: 800, width: 64, height: 64 },
            { x: 576, y: 864, width: 512, height: 64 },
            { x: 352, y: 704, width: 64, height: 256 },
            { x: 416, y: 608, width: 64, height: 64 },
            { x: 480, y: 544, width: 64, height: 192 },
            { x: 544, y: 416, width: 192, height: 64 },
            { x: 992, y: 352, width: 320, height: 64 },
            { x: 800, y: 544, width: 192, height: 64 },
            { x: 1216, y: 544, width: 256, height: 64 },
            { x: 992, y: 736, width: 48, height: 64 }
        ]);

        // Crea le piattaforme pericolose
        this.dangerousPlatforms = createRectangularPlatforms(this, [
            { x: 992, y: 994, width: 192, height: 60 } // Piattaforma pericolosa 1
        ]);

        // Crea le monete
        this.coins = this.physics.add.group({
            key: 'coin',
            frameQuantity: 0, // Nessuna moneta inizialmente
            collideWorldBounds: true,
            immovable: false
        });

        // Crea il bonus
        this.bonus = null; // Variabile per il bonus

        // Mostra la prima moneta
        this.showNextCoin();

        // Gestisci le collisioni
        this.physics.add.collider(this.cat.gatto, this.platforms);
        this.physics.add.collider(this.coins, this.platforms);
        this.physics.add.collider(this.cat.gatto, this.dangerousPlatforms, this.handleDangerousPlatformCollision, null, this);
        this.physics.add.overlap(this.cat.gatto, this.coins, (cat, coin) => {
            coin.setAlpha(0); // Nascondi la moneta
            this.coins.remove(coin); // Rimuovi la moneta dal gruppo
            this.cat.collectCoin(); // Incrementa il numero delle monete
            this.currentCoins++;
            if (this.currentCoins % this.bonusSpawnInterval === 0) {
                this.showBonus(); // Mostra la pozione bonus
            }
            if (this.currentCoins < 25) {
                this.showNextCoin(); // Mostra la prossima moneta
            } else {
                this.sound.play('25coin_sound');
                // Passa alla scena successiva se sono state raccolte 25 monete
                this.scene.start('Scene4');
            }
            this.sound.play('coin_sound');
        });

        // Configura i tasti di input
        this.cursors = this.input.keyboard.createCursorKeys();
        this.keys = {
            left: this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.A),
            right: this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.D),
            shift: this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.SHIFT),
            jump: this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.SPACE),
            attack: this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.E)
        };
    }

    update() {
        this.cat.update(this.cursors, this.keys);
    }

    showNextCoin() {
        if (this.currentCoins >= 25) return; // Non mostrare più monete se ne sono state raccolte 25

        // Seleziona una posizione casuale dalle posizioni disponibili
        const randomIndex = Phaser.Math.Between(0, this.coinPositions.length - 1);
        const { x, y } = this.coinPositions[randomIndex];

        // Crea una nuova moneta nella posizione specificata
        const coin = this.coins.create(x, y, 'coin');
        coin.setScale(0.7);
        coin.setOrigin(0.5, 0.5);
        coin.setSize(64, 64);
        coin.setOffset(0, 0);

        // Crea l'animazione di rotazione per la moneta
        this.anims.create({
            key: 'spin',
            frames: this.anims.generateFrameNumbers('coin', { start: 0, end: 13 }),
            frameRate: 24,
            repeat: -1
        });
        coin.anims.play('spin');
    }

    showBonus() {
        if (this.bonus) {
            this.bonus.destroy(); // Distruggi la pozione esistente se presente
        }

        // Seleziona una posizione casuale dalle posizioni delle monete già usate
        if (this.coins.getLength() === 0) return; // Nessuna moneta disponibile per determinare la posizione del bonus

        // Seleziona una posizione casuale tra le posizioni delle monete
        const randomIndex = Phaser.Math.Between(0, this.coinPositions.length - 1);
        const { x, y } = this.coinPositions[randomIndex];

        // Crea la pozione bonus nella posizione selezionata
        this.bonus = this.physics.add.sprite(x, y, 'bonus');
        this.bonus.setScale(1.4); // Aumenta la dimensione della pozione
        this.bonus.setSize(20, 25); // Imposta la dimensione fisica della pozione
        this.bonus.setOffset(0, 0); // Offset per centrare la dimensione fisica
        this.physics.add.collider(this.bonus, this.platforms); // Abilita la collisione tra bonus e piattaforme
        this.physics.add.overlap(this.cat.gatto, this.bonus, this.collectBonus, null, this); // Gestisci la collisione con il bonus
    }

    collectBonus(cat, bonus) {
        this.sound.play('bonus_sound'); // Riproduci il suono del bonus
        this.cat.increaseLife(); // Aumenta la vita del gatto
        bonus.disableBody(true, true); // Nascondi e disabilita il bonus dopo che è stato raccolto
    }

    handleDangerousPlatformCollision(cat, platform) {
        this.sound.play('damage_sound');
        this.cat.loseLife(); // Riduci la vita del gatto
        this.cat.gatto.setPosition(this.startingPosition.x, this.startingPosition.y); // Riporta il gatto al punto di partenza
    }
}



        // Scene 4
        class Scene4 extends Phaser.Scene {
            constructor() {
                super({ key: 'Scene4' });
                this.cat = new Cat(this);
            }

            preload() {
                this.cat.preload();
                this.load.image('mappa_4', 'assets/mappa_4.png');
                this.load.audio('coin_sound', 'assets/suono_raccolta_moneta_2.mp3');
                this.load.audio('25coin_sound', 'assets/suono_raccolta_moneta_1.mp3');
            }

            create() {
                this.add.image(this.scale.width / 2, this.scale.height / 2, 'mappa_4');
                this.cat.create(300, 300);

                // Crea le piattaforme
                this.platforms = createRectangularPlatforms(this, [
                    { x: 64, y: 512, width: 128, height: 1024 },
                    { x: 992, y: 64, width: 1984, height: 128 },
                    { x: 1920, y: 512, width: 128, height: 1024 },
                    { x: 992, y: 960, width: 1984, height: 128 },
                ]);

                // Non creiamo monete in questa scena

                this.physics.add.collider(this.cat.gatto, this.platforms);

                // Cambia la scena solo se si preme un tasto specifico, non con un clic
                this.input.keyboard.on('keydown-ENTER', () => {
                    this.scene.start('Scene1');
                });

                this.cursors = this.input.keyboard.createCursorKeys();
                this.keys = {
                    left: this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.A),
                    right: this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.D),
                    shift: this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.SHIFT),
                    jump: this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.SPACE),
                    attack: this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.E)
                };

                // Rimuovi la scritta delle monete se è presente
                if (this.coinsText) {
                    this.coinsText.destroy();
                }
            }

            update() {
                this.cat.update(this.cursors, this.keys);
            }
        }

        





        // Configurazione del gioco
        const config = {
            type: Phaser.AUTO,
            width: 1984,
            height: 1024,
            scene: [Scene1, Scene2, Scene3, Scene4], // Ordine delle scene
            physics: {
                default: 'arcade',
                arcade: {
                    gravity: { y: 300 },
                    debug: true
                }
            },
            scale: {
                mode: Phaser.Scale.FIT,
                autoCenter: Phaser.Scale.CENTER_BOTH
            }
        };

        // Crea l'istanza del gioco
        const game = new Phaser.Game(config);


    </script>

</body>

</html>